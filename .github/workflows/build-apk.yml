name: Build APK from ZIP

on:
  workflow_dispatch:
  push:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: false

      - name: Accept Android SDK licenses (non-interactive)
        run: |
          yes | sdkmanager --licenses > /dev/null

      - name: Install Android SDK packages
        run: |
          sdkmanager "platform-tools" "platforms;android-34" "build-tools;34.0.0"

      - name: Unzip project
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip dos2unix
          unzip -o -q "MealPlanner.zip" -d "extracted"
          echo "Project root listing:"
          ls -la "extracted/GithubMealTester"

      - name: Setup Gradle 8.2.1
        uses: gradle/gradle-build-action@v3
        with:
          gradle-version: "8.2.1"

      - name: Generate Gradle Wrapper (missing in ZIP)
        working-directory: extracted/GithubMealTester
        run: |
          gradle wrapper --gradle-version 8.2.1
          dos2unix "./gradlew" || true
          chmod +x "./gradlew"

      - name: Create placeholder launcher icons (fix missing mipmap)
        run: |
          RES_DIR="extracted/GithubMealTester/app/src/main/res"
          mkdir -p "${RES_DIR}/mipmap-mdpi"
          ICON_B64="iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/x8AAwMCAO+X2u0AAAAASUVORK5CYII="
          echo "${ICON_B64}" | base64 -d > "${RES_DIR}/mipmap-mdpi/ic_launcher.png"
          echo "${ICON_B64}" | base64 -d > "${RES_DIR}/mipmap-mdpi/ic_launcher_round.png"
          ls -la "${RES_DIR}/mipmap-mdpi"

      - name: Patch removed WebView API (setAppCacheEnabled)
        run: |
          FILE="extracted/GithubMealTester/app/src/main/java/com/example/githubmealtester/WebViewFragment.java"
          sed -i '/setAppCacheEnabled\s*(/d' "${FILE}"
          grep -n "setAppCacheEnabled" "${FILE}" || true

      - name: Patch MainActivity to keep tabs alive (offscreen limit)
        run: |
          set -e
          FILE="extracted/GithubMealTester/app/src/main/java/com/example/githubmealtester/MainActivity.java"

          if [ ! -f "${FILE}" ]; then
            echo "ERROR: MainActivity.java not found at: ${FILE}"
            exit 1
          fi

          if grep -q "setOffscreenPageLimit" "${FILE}"; then
            echo "OffscreenPageLimit already set. No changes needed."
          else
            sed -i 's/\(viewPager\.setAdapter([^;]*;\)/\1\n        viewPager.setOffscreenPageLimit(4);/' "${FILE}"
          fi

          echo "MainActivity offscreen line:"
          grep -n "setOffscreenPageLimit" "${FILE}" || true

      - name: Patch WebViewFragment to hide web header/nav (CSS injection)
        run: |
          python3 - << 'PY'
          import re
          from pathlib import Path

          path = Path("extracted/GithubMealTester/app/src/main/java/com/example/githubmealtester/WebViewFragment.java")
          if not path.exists():
              raise SystemExit(f"ERROR: {path} not found")

          s = path.read_text(encoding="utf-8")

          # Skip if already patched
          if "injectChromeHider(" in s:
              print("Already patched: injectChromeHider exists.")
              raise SystemExit(0)

          # Insert call inside onPageFinished
          m = re.search(r'(onPageFinished\s*\(\s*WebView\s+view\s*,\s*String\s+url\s*\)\s*\{)', s)
          if not m:
              raise SystemExit("ERROR: onPageFinished(WebView view, String url) not found")

          insert_at = m.end()
          s = s[:insert_at] + "\n            injectChromeHider(view);\n" + s[insert_at:]

          helper = """
          private void injectChromeHider(WebView view) {
              // Hide the site's header/nav so native tabs feel like the real navigation.
              String css = "header, nav, [role=\\\\\\"navigation\\\\\\"], .navbar, .topbar, .tabs { display:none !important; }"
                      + "body { padding-top: 0 !important; margin-top: 0 !important; }";

              String js = "(function(){try{"
                      + "var st=document.getElementById('nativeChromeHide');"
                      + "if(!st){st=document.createElement('style');st.id='nativeChromeHide';document.head.appendChild(st);}"
                      + "st.innerHTML=\\\\\\"" + css.replace("\\\\", "\\\\\\\\").replace("\\"", "\\\\\\"") + "\\\\\\";"
                      + "}catch(e){}})();";

              view.evaluateJavascript(js, null);
          }
          """.strip()

          # Add helper before final closing brace of class
          i = s.rfind("}")
          if i == -1:
              raise SystemExit("ERROR: class closing brace not found")

          s = s[:i] + "\n\n" + helper + "\n" + s[i:]
          path.write_text(s, encoding="utf-8")
          print("Patched WebViewFragment.java with CSS injection.")
          PY

      - name: Build debug APK
        working-directory: extracted/GithubMealTester
        run: |
          ./gradlew --no-daemon --stacktrace assembleDebug

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-debug-apk
          path: extracted/GithubMealTester/app/build/outputs/apk/debug/*.apk
