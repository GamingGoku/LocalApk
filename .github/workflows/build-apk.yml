name: "Build APK from ZIP"

on:
  workflow_dispatch:
  push:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: "Checkout"
        uses: actions/checkout@v4

      - name: "Set up JDK 17"
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      # IMPORTANT: don't let this action try to accept licenses interactively
      - name: "Setup Android SDK"
        uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: false

      - name: "Accept Android SDK licenses (non-interactive)"
        run: |
          yes | sdkmanager --licenses > /dev/null

      - name: "Install Android SDK packages"
        run: |
          sdkmanager "platform-tools" "platforms;android-34" "build-tools;34.0.0"

      - name: "Unzip project"
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip dos2unix
          unzip -o -q "MealPlanner.zip" -d "extracted"
          echo "Project root listing:"
          ls -la "extracted/GithubMealTester"

      - name: "Setup Gradle 8.2.1"
        uses: gradle/gradle-build-action@v3
        with:
          gradle-version: "8.2.1"

      - name: "Generate Gradle Wrapper (missing in ZIP)"
        working-directory: "extracted/GithubMealTester"
        run: |
          gradle wrapper --gradle-version 8.2.1
          dos2unix "./gradlew" || true
          chmod +x "./gradlew"

      - name: "Create placeholder launcher icons (fix missing mipmap)"
        run: |
          RES_DIR="extracted/GithubMealTester/app/src/main/res"
          mkdir -p "${RES_DIR}/mipmap-mdpi"
          ICON_B64="iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/x8AAwMCAO+X2u0AAAAASUVORK5CYII="
          echo "${ICON_B64}" | base64 -d > "${RES_DIR}/mipmap-mdpi/ic_launcher.png"
          echo "${ICON_B64}" | base64 -d > "${RES_DIR}/mipmap-mdpi/ic_launcher_round.png"

      - name: "Patch removed WebView API (setAppCacheEnabled)"
        run: |
          FILE="extracted/GithubMealTester/app/src/main/java/com/example/githubmealtester/WebViewFragment.java"
          sed -i '/setAppCacheEnabled\s*(/d' "${FILE}"
          grep -n "setAppCacheEnabled" "${FILE}" || true

      - name: "Patch WebViewFragment to hide web chrome (CSS injection)"
        run: |
          set -e
          FILE="extracted/GithubMealTester/app/src/main/java/com/example/githubmealtester/WebViewFragment.java"
          echo "Patching ${FILE}"
          if [ ! -f "${FILE}" ]; then
            echo "ERROR: WebViewFragment not found"
            exit 1
          fi

          python3 - << 'PY'
          import re, pathlib
          p = pathlib.Path("extracted/GithubMealTester/app/src/main/java/com/example/githubmealtester/WebViewFragment.java")
          s = p.read_text(encoding="utf-8")

          if "injectAppChromeHider" in s:
              print("Already patched.")
              exit(0)

          helper = r"""
          private void injectAppChromeHider(WebView view) {
              // Hide website chrome so native tabs feel like real navigation.
              String css = ""
                  + "header, nav, .topbar, .navbar, .nav, .tabs, .top-tabs, "
                  + "[role=\\\"navigation\\\"], "
                  + "body > header, body > nav { display:none !important; }"
                  + " .container { padding-top: 0 !important; margin-top: 0 !important; }";

              String js = ""
                  + "(function(){"
                  + "  try {"
                  + "    var style=document.getElementById('nativeChromeHide');"
                  + "    if(!style){"
                  + "      style=document.createElement('style');"
                  + "      style.id='nativeChromeHide';"
                  + "      document.head.appendChild(style);"
                  + "    }"
                  + "    style.innerHTML=`" + css.replace("`","\\`") + "`;"
                  + "  } catch(e) {}"
                  + "})();";
              view.evaluateJavascript(js, null);
          }
          """.strip("\n")

          m = re.search(r"onPageFinished\s*\(\s*WebView\s+\w+,\s*String\s+\w+\s*\)\s*\{", s)
          if not m:
              raise SystemExit("Couldn't find onPageFinished(...) to patch.")

          insert_at = m.end()
          s2 = s[:insert_at] + "\n            injectAppChromeHider(view);\n" + s[insert_at:]

          last_brace = s2.rfind("}")
          if last_brace == -1:
              raise SystemExit("Couldn't find class closing brace.")
          s2 = s2[:last_brace] + "\n\n" + helper + "\n" + s2[last_brace:]

          p.write_text(s2, encoding="utf-8")
          print("Patched WebViewFragment.java with CSS injection.")
          PY

          grep -n "injectAppChromeHider" "${FILE}" | head -n 5

      - name: "Patch MainActivity to keep tabs alive (offscreen limit)"
        run: |
          set -e
          FILE="extracted/GithubMealTester/app/src/main/java/com/example/githubmealtester/MainActivity.java"

          if [ ! -f "${FILE}" ]; then
            echo "ERROR: MainActivity.java not found at: ${FILE}"
            exit 1
          fi

          if grep -q "setOffscreenPageLimit" "${FILE}"; then
            echo "OffscreenPageLimit already set. No changes needed."
            exit 0
          fi

          sed -i 's/\(viewPager\.setAdapter([^;]*;\)/\1\n        viewPager.setOffscreenPageLimit(4);/' "${FILE}"

          echo "Patched MainActivity.java:"
          grep -n "setOffscreenPageLimit" "${FILE}" || true

      - name: "Build debug APK"
        working-directory: "extracted/GithubMealTester"
        run: |
          ./gradlew --no-daemon --stacktrace assembleDebug

      - name: "Upload APK artifact"
        uses: actions/upload-artifact@v4
        with:
          name: "app-debug-apk"
          path: "extracted/GithubMealTester/app/build/outputs/apk/debug/*.apk"

