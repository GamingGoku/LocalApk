name: Build APK from ZIP

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: true

      - name: Accept SDK licenses (non-interactive)
        shell: bash
        run: |
          yes | sdkmanager --licenses >/dev/null

      - name: Unzip project
        shell: bash
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y unzip
          rm -rf extracted
          unzip -o -q "MealPlanner.zip" -d "extracted"
          echo "Extracted top level:"
          ls -la extracted
          echo "Project tree:"
          find extracted -maxdepth 3 -type f -o -type d | sed -n '1,200p'

      - name: Patch MainActivity to keep tabs alive (offscreen limit)
        shell: bash
        run: |
          set -e
          FILE="extracted/GithubMealTester/app/src/main/java/com/example/githubmealtester/MainActivity.java"

          if [ ! -f "${FILE}" ]; then
            echo "ERROR: MainActivity.java not found at: ${FILE}"
            exit 1
          fi

          if grep -q "setOffscreenPageLimit" "${FILE}"; then
            echo "OffscreenPageLimit already set. No changes needed."
            exit 0
          fi

          sed -i 's/\(viewPager\.setAdapter([^;]*;\)/\1\n        viewPager.setOffscreenPageLimit(4);/' "${FILE}"

          echo "Patched line(s):"
          grep -n "setOffscreenPageLimit" "${FILE}" || true

      - name: Build debug APK
        shell: bash
        working-directory: extracted/GithubMealTester
        run: |
          set -e
          chmod +x ./gradlew
          ./gradlew --no-daemon assembleDebug

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-debug-apk
          path: extracted/GithubMealTester/app/build/outputs/apk/debug/*.apk
